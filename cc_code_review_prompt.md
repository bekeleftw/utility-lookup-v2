# Claude Code Review Prompt: Utility Lookup Engine Audit
## February 6, 2026

```
Review all code in the utility-lookup-v2/ project. This was generated by Windsurf/Cascade across 8+ prompts over one session. I need you to verify the implementation matches the stated requirements before I run 87K addresses through it. Do NOT fix anything yet — just report what you find.

## Files to Review

### Core Engine (lookup_engine/)
- __init__.py
- models.py
- config.py
- spatial_index.py
- geocoder.py
- scorer.py
- cache.py
- engine.py

### Normalizer
- provider_normalizer.py
- data/canonical_providers.json
- data/deregulated_reps.json

### Tests
- lookup_engine/tests/test_engine.py

### Supporting
- run_engine.py

## What to Check

### 1. Spatial Index (spatial_index.py)
- [ ] Does it load ALL three shapefiles (electric, gas, water)?
- [ ] Does it reproject electric + gas to EPSG:4326? (Electric is EPSG:3857, gas may vary, water is already 4326)
- [ ] Does it call make_valid() on geometries?
- [ ] Does it query by geometry intersection, NOT by filtering STATE field? (Critical: AEP Texas is stored under STATE=OK in the HIFLD shapefile — a STATE=='TX' filter will miss it)
- [ ] Does point-in-polygon use (lon, lat) order for shapely Point? (shapely is x,y = lon,lat, NOT lat,lon)
- [ ] When multiple polygons match, does it resolve by smallest area first?
- [ ] For Texas specifically, does it apply the priority order: municipals/co-ops first, then TNMP, then CenterPoint, then AEP, then Oncor?

### 2. Scorer (scorer.py)
- [ ] Does it match shapefile results to canonical_providers.json using EIA ID as the primary join key?
- [ ] If EIA ID match fails, does it fall back to name normalization?
- [ ] Does it detect deregulated markets (ERCOT) and flag is_deregulated=true for TDU results?
- [ ] Does it correctly identify TX co-ops and municipals as NOT deregulated (even though they're in Texas)?
- [ ] Are confidence scores assigned correctly: boundary match (0.85), GIS polygon (0.80), name-only (0.70)?

### 3. Provider Normalizer (provider_normalizer.py)
- [ ] Does normalize_provider() still work for single strings (backward compatible)?
- [ ] Does normalize_provider_multi() split on commas and normalize each segment?
- [ ] Is REP detection STRICT (exact match against deregulated_reps.json only)? It must NOT use fuzzy matching for REP detection — that was a bug we fixed.
- [ ] Does fuzzy matching use 90% threshold for shapefile names and 85% for tenant input? (Or is it a single threshold?)
- [ ] Are holding companies blocked from being returned as display names (_HOLDING_COMPANIES set)?
- [ ] Does the null value skip list work (N/A, None, Landlord, etc.)?
- [ ] Are propane companies handled separately?

### 4. Canonical Providers (data/canonical_providers.json)
- [ ] Approximately 446 entries?
- [ ] 0 alias collisions (same alias mapping to two different providers)?
- [ ] EIA IDs present on ~245 entries?
- [ ] No holding company names as display_name values?
- [ ] Spot-check: "NV Energy" display_name is "NV Energy" (not "Berkshire Hathaway Energy")
- [ ] Spot-check: "Columbia Gas" has no bare unqualified alias (only state-qualified: "Columbia Gas of Ohio", etc.)
- [ ] Spot-check: TXU Energy is NOT a canonical provider (it's a REP, should only be in deregulated_reps.json)

### 5. Deregulated REPs (data/deregulated_reps.json)
- [ ] ~105 TX REP entries?
- [ ] Does NOT contain legitimate utilities (check for: Bryan Texas Utilities, Grayson-Collin Electric, CPS Energy, Austin Energy — these are NOT REPs)
- [ ] Does NOT contain non-TX utilities (Tallahassee, Florence AL, Middle Tennessee Electric — these were false positives we removed)

### 6. Engine Orchestration (engine.py)
- [ ] Does it geocode first, then spatial query, then normalize, then score?
- [ ] Does it use the cache (check before geocoding, store after)?
- [ ] Does it handle geocoding failures gracefully (return error, don't crash)?
- [ ] Does it return results for all three utility types (electric, gas, water)?
- [ ] What does the response format look like? Print an example full response for a Dallas TX address.

### 7. Config (config.py)
- [ ] Are file paths correct and relative to the project root?
- [ ] Does the ERCOT TDU list include all 6: Oncor, CenterPoint, AEP Texas Central, AEP Texas North, TNMP, Lubbock P&L?
- [ ] Is Lubbock P&L treated as deregulated (it joined ERCOT in 2024)?

### 8. Tests (test_engine.py)
- [ ] Do all 47 tests pass when you run them?
- [ ] Is there a test for AEP Texas (the STATE=OK issue)?
- [ ] Is there a test for a TX co-op returning is_deregulated=False?
- [ ] Is there a test for a TX TDU returning is_deregulated=True?
- [ ] Is there a test for overlap resolution (Dallas should return Oncor, not TNMP even though both polygons cover it)?

### 9. General Code Quality
- [ ] Any hardcoded file paths that will break in a different environment?
- [ ] Any external API calls happening at query time other than geocoding?
- [ ] Any OpenAI/LLM calls anywhere? (There should be ZERO)
- [ ] Any try/except blocks that silently swallow errors?
- [ ] Memory usage — does it load all three shapefiles into memory? What's the approximate memory footprint?

## Output Format

For each section above, report:
- ✅ PASS — requirement met
- ⚠️ ISSUE — works but has a concern (describe)
- ❌ FAIL — requirement not met (describe, suggest fix)

At the end, provide:
1. Total: X pass, X issues, X fails
2. List of all ❌ FAIL items with recommended fixes
3. List of all ⚠️ ISSUE items ranked by severity
4. Overall assessment: is this engine ready for a batch validation run against 87K addresses?
```
